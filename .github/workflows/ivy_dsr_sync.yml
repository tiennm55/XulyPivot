name: IvyCPG DSR Today Sync (All-in-One)

on:
  schedule:
    - cron: '30 1 * * *' # 8:30 s√°ng VN h√†ng ng√†y
  workflow_dispatch:

jobs:
  sync_dsr:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright requests
          playwright install chromium

      - name: Run IvyCPG Scraper and Upload to OneDrive
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          USER_EMAIL: "tiennm@tuanvietc5.id.vn"
          BRANCH_NAME: "CN PHU YEN"
          BRANCH_CODE: "PHYEN"
          OUT_FOLDER: "/1.Job/2425/1. Tracking/Daily Sell Report/Data"
          DAYS_OFFSET: "0"
        run: |
          python - <<'PYCODE'
          import os, time, requests, io
          from datetime import datetime, timedelta
          from playwright.sync_api import sync_playwright

          TENANT_ID = os.environ["TENANT_ID"]
          CLIENT_ID = os.environ["CLIENT_ID"]
          CLIENT_SECRET = os.environ["CLIENT_SECRET"]
          USER_EMAIL = os.environ["USER_EMAIL"]
          OUT_FOLDER = os.environ["OUT_FOLDER"]
          BRANCH_NAME = os.environ["BRANCH_NAME"]
          BRANCH_CODE = os.environ["BRANCH_CODE"]
          DAYS_OFFSET = int(os.environ.get("DAYS_OFFSET", 0))
          GRAPH_API = "https://graph.microsoft.com/v1.0"

          # H√ÄM CHUY·ªÇN ƒê·ªîI SANG GI·ªú VI·ªÜT NAM (UTC+7)
          def get_vn_now():
              return datetime.utcnow() + timedelta(hours=7)

          def get_access_token():
              url = f"https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token"
              data = {
                  "grant_type": "client_credentials",
                  "client_id": CLIENT_ID,
                  "client_secret": CLIENT_SECRET,
                  "scope": "https://graph.microsoft.com/.default",
              }
              res = requests.post(url, data=data)
              return res.json().get("access_token")

          def run_automation():
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  page = browser.new_page()
                  
                  # L·∫•y th·ªùi gian hi·ªán t·∫°i theo m√∫i gi·ªù VN
                  now_vn = get_vn_now()
                  
                  # T√≠nh to√°n ng√†y c·∫ßn ch·ªçn tr√™n l·ªãch d·ª±a tr√™n Offset
                  target_date = now_vn + timedelta(days=DAYS_OFFSET)
                  day_to_select = str(target_date.day)

                  print(f"üöÄ [VN Time: {now_vn.strftime('%H:%M')}] Target: {BRANCH_NAME} | Date: {day_to_select}")
                  
                  page.goto("https://png-vn.ivycpg.com/web/")
                  page.get_by_role("textbox", name="Username *").fill("2001584413.admin")
                  page.get_by_role("textbox", name="Password *").fill("TVIET@2025#$")
                  page.get_by_role("button", name="Login").click()
                  
                  page.wait_for_load_state("networkidle")
                  time.sleep(5)

                  page.get_by_role("link", name="Óöî Reports ÓüÉ").click()
                  page.get_by_role("link", name="Óöî DSR Today", exact=True).click()

                  iframe_main = page.frame_locator("#iContent")
                  iframe_main.get_by_role("textbox").first.click()
                  iframe_main.get_by_role("list").get_by_text(BRANCH_NAME).click()
                  
                  iframe_main.get_by_role("textbox", name="Date").click()
                  iframe_main.get_by_role("link", name=day_to_select, exact=True).click()
                  iframe_main.get_by_text("DSR Today").click()

                  iframe_report = iframe_main.frame_locator("#myReportIFrame")
                  export_btn = iframe_report.get_by_role("link", name="Export drop down menu Export")
                  export_btn.wait_for(state="visible", timeout=120000)
                  export_btn.click()

                  with page.expect_download() as download_info:
                      with page.expect_popup() as page1_info:
                          iframe_report.get_by_role("link", name="Excel").click()
                      page1 = page1_info.value
                      page1.close()
                      
                  download = download_info.value
                  
                  # ƒê·∫∑t t√™n file theo Gi·ªù Vi·ªát Nam: PHYEN_060226_1151
                  file_name = f"{BRANCH_CODE}_{now_vn.strftime('%d%m%y_%H%M')}.xlsx"
                  
                  temp_path = download.path()
                  with open(temp_path, "rb") as f:
                      file_content = f.read()
                  
                  browser.close()
                  return file_name, file_content

          try:
              fname, fcontent = run_automation()
              token = get_access_token()
              headers = {"Authorization": f"Bearer {token}"}

              drive_res = requests.get(f"{GRAPH_API}/users/{USER_EMAIL}/drive", headers=headers).json()
              drive_id = drive_res["id"]

              upload_url = f"{GRAPH_API}/drives/{drive_id}/root:{OUT_FOLDER}/{fname}:/content?@microsoft.graph.conflictBehavior=replace"
              up_res = requests.put(upload_url, headers=headers, data=fcontent)

              if up_res.ok:
                  print(f"‚úÖ Th√†nh c√¥ng: {fname} ƒë√£ l√™n OneDrive (Gi·ªù VN).")
              else:
                  print(f"‚ùå L·ªói upload: {up_res.text}")

          except Exception as e:
              print(f"‚ùå L·ªói: {e}")
              exit(1)
          PYCODE
