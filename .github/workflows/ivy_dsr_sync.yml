name: IvyCPG DSR Today Sync (All 13 Branches)

on:
  schedule:
    - cron: '30 1 * * *' # 8:30 s√°ng VN h√†ng ng√†y
  workflow_dispatch:

jobs:
  sync_dsr:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright requests
          playwright install chromium

      - name: Run IvyCPG Scraper for All Branches
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          USER_EMAIL: "tiennm@tuanvietc5.id.vn"
          OUT_FOLDER: "/1.Job/2425/1. Tracking/Daily Sell Report/Data"
          DAYS_OFFSET: "0"
        run: |
          python - <<'PYCODE'
          import os, time, requests, io
          from datetime import datetime, timedelta
          from playwright.sync_api import sync_playwright

          # 1. C·∫•u h√¨nh chung
          TENANT_ID = os.environ["TENANT_ID"]
          CLIENT_ID = os.environ["CLIENT_ID"]
          CLIENT_SECRET = os.environ["CLIENT_SECRET"]
          USER_EMAIL = os.environ["USER_EMAIL"]
          OUT_FOLDER = os.environ["OUT_FOLDER"]
          DAYS_OFFSET = int(os.environ.get("DAYS_OFFSET", 0))
          GRAPH_API = "https://graph.microsoft.com/v1.0"

          # DANH S√ÅCH 13 CHI NH√ÅNH T·ª™ ·∫¢NH G·ª¨I
          BRANCHES = [
              {"name": "CN BINH DINH", "code": "BDINH"},
              {"name": "CN DA NANG", "code": "DNANG"},
              {"name": "CN HA TINH", "code": "HTINH"},
              {"name": "CN HUE", "code": "HUE"},
              {"name": "CN KHANH HOA", "code": "KHOA"},
              {"name": "CN PHU YEN", "code": "PHYEN"},
              {"name": "CN QUANG BINH", "code": "QBINH"},
              {"name": "CN QUANG NAM", "code": "QNAM"},
              {"name": "CN QUANG NGAI", "code": "QNGAI"},
              {"name": "CN QUANG TRI", "code": "QTRI"},
              {"name": "CN QUYNH LUU", "code": "QLUU"},
              {"name": "CN THANH HOA", "code": "THOA"},
              {"name": "CN VINH", "code": "VINH"}
          ]

          def get_vn_now():
              return datetime.utcnow() + timedelta(hours=7)

          def get_access_token():
              url = f"https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token"
              data = {
                  "grant_type": "client_credentials",
                  "client_id": CLIENT_ID,
                  "client_secret": CLIENT_SECRET,
                  "scope": "https://graph.microsoft.com/.default",
              }
              res = requests.post(url, data=data)
              return res.json().get("access_token")

          def run_automation_for_branch(page, branch, target_day):
              print(f"üåÄ ƒêang x·ª≠ l√Ω: {branch['name']}...")
              
              # Reset v·ªÅ trang DSR Today
              page.get_by_role("link", name="Óöî DSR Today", exact=True).click()
              time.sleep(3)

              iframe_main = page.frame_locator("#iContent")
              
              # Ch·ªçn Chi nh√°nh
              iframe_main.get_by_role("textbox").first.click()
              iframe_main.get_by_role("list").get_by_text(branch['name'], exact=True).click()
              time.sleep(1)
              
              # Ch·ªçn Ng√†y
              iframe_main.get_by_role("textbox", name="Date").click()
              iframe_main.get_by_role("link", name=target_day, exact=True).click()
              
              # B·∫•m xem b√°o c√°o
              iframe_main.get_by_text("DSR Today").click()
              time.sleep(2)

              # Xu·∫•t Excel
              iframe_report = iframe_main.frame_locator("#myReportIFrame")
              export_btn = iframe_report.get_by_role("link", name="Export drop down menu Export")
              export_btn.wait_for(state="visible", timeout=120000)
              export_btn.click()

              with page.expect_download() as download_info:
                  with page.expect_popup() as page1_info:
                      iframe_report.get_by_role("link", name="Excel").click()
                  page1 = page1_info.value
                  page1.close()
                  
              download = download_info.value
              now_vn = get_vn_now()
              file_name = f"{branch['code']}_{now_vn.strftime('%d%m%y_%H%M')}.xlsx"
              
              temp_path = download.path()
              with open(temp_path, "rb") as f:
                  content = f.read()
              
              return file_name, content

          # --- Main Execution ---
          try:
              token = get_access_token()
              headers = {"Authorization": f"Bearer {token}"}
              drive_res = requests.get(f"{GRAPH_API}/users/{USER_EMAIL}/drive", headers=headers).json()
              drive_id = drive_res["id"]

              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  page = browser.new_page()
                  
                  # ƒêƒÉng nh·∫≠p
                  page.goto("https://png-vn.ivycpg.com/web/")
                  page.get_by_role("textbox", name="Username *").fill("2001584413.admin")
                  page.get_by_role("textbox", name="Password *").fill("TVIET@2025#$")
                  page.get_by_role("button", name="Login").click()
                  page.wait_for_load_state("networkidle")
                  time.sleep(5)
                  
                  page.get_by_role("link", name="Óöî Reports ÓüÉ").click()
                  
                  target_day = str((get_vn_now() + timedelta(days=DAYS_OFFSET)).day)

                  for branch in BRANCHES:
                      try:
                          fname, fcontent = run_automation_for_branch(page, branch, target_day)
                          
                          upload_url = f"{GRAPH_API}/drives/{drive_id}/root:{OUT_FOLDER}/{fname}:/content?@microsoft.graph.conflictBehavior=replace"
                          up_res = requests.put(upload_url, headers=headers, data=fcontent)
                          
                          if up_res.ok:
                              print(f"‚úÖ {fname} -> OneDrive OK")
                          else:
                              print(f"‚ùå {fname} Upload Fail: {up_res.text}")
                              
                      except Exception as e:
                          print(f"‚ö†Ô∏è L·ªói t·∫°i {branch['name']}: {e}")
                          continue

                  browser.close()
                  print("\nüèÅ ƒê√£ ho√†n th√†nh t·∫£i d·ªØ li·ªáu cho t·∫•t c·∫£ chi nh√°nh!")

          except Exception as e:
              print(f"‚ùå L·ªói h·ªá th·ªëng nghi√™m tr·ªçng: {e}")
              exit(1)
          PYCODE
