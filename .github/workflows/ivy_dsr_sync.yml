name: IvyCPG DSR Today Sync (All-in-One)

on:
  schedule:
    - cron: '30 1 * * *' # 8:30 s√°ng VN h√†ng ng√†y
  workflow_dispatch:

jobs:
  sync_dsr:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright requests
          playwright install chromium

      - name: Run IvyCPG Scraper and Upload to OneDrive
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          USER_EMAIL: "tiennm@tuanvietc5.id.vn"
          OUT_FOLDER: "/1.Job/2425/1. Tracking/Pivot_IDS" 
        run: |
          python - <<'PYCODE'
          import os, time, requests, io
          from datetime import datetime
          from playwright.sync_api import sync_playwright

          TENANT_ID = os.environ["TENANT_ID"]
          CLIENT_ID = os.environ["CLIENT_ID"]
          CLIENT_SECRET = os.environ["CLIENT_SECRET"]
          USER_EMAIL = os.environ["USER_EMAIL"]
          OUT_FOLDER = os.environ["OUT_FOLDER"]
          GRAPH_API = "https://graph.microsoft.com/v1.0"

          def get_access_token():
              url = f"https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token"
              data = {
                  "grant_type": "client_credentials",
                  "client_id": CLIENT_ID,
                  "client_secret": CLIENT_SECRET,
                  "scope": "https://graph.microsoft.com/.default",
              }
              res = requests.post(url, data=data)
              return res.json().get("access_token")

          def run_automation():
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  page = browser.new_page()
                  
                  target_dt = datetime.now()
                  day_to_select = str(target_dt.day)

                  print(f"üöÄ B·∫Øt ƒë·∫ßu l·∫•y d·ªØ li·ªáu ng√†y {day_to_select} ...")
                  
                  page.goto("https://png-vn.ivycpg.com/web/")
                  page.get_by_role("textbox", name="Username *").fill("2001584413.admin")
                  page.get_by_role("textbox", name="Password *").fill("TVIET@2025#$")
                  page.get_by_role("button", name="Login").click()
                  
                  page.wait_for_load_state("networkidle")
                  time.sleep(5)

                  page.get_by_role("link", name="Óöî Reports ÓüÉ").click()
                  page.get_by_role("link", name="Óöî DSR Today", exact=True).click()

                  iframe_main = page.frame_locator("#iContent")
                  iframe_main.get_by_role("textbox").first.click()
                  iframe_main.get_by_role("list").get_by_text("CN PHU YEN").click()
                  
                  iframe_main.get_by_role("textbox", name="Date").click()
                  iframe_main.get_by_role("link", name=day_to_select, exact=True).click()
                  iframe_main.get_by_text("DSR Today").click()

                  iframe_report = iframe_main.frame_locator("#myReportIFrame")
                  export_btn = iframe_report.get_by_role("link", name="Export drop down menu Export")
                  export_btn.wait_for(state="visible", timeout=120000)
                  export_btn.click()

                  with page.expect_download() as download_info:
                      with page.expect_popup() as page1_info:
                          iframe_report.get_by_role("link", name="Excel").click()
                      page1 = page1_info.value
                      page1.close()
                      
                  download = download_info.value
                  file_name = f"DSR_PhuYen_{target_dt.strftime('%d%m%Y')}.xlsx"
                  
                  # S·ª¨A L·ªñI T·∫†I ƒê√ÇY: D√πng download.path() thay v√¨ create_read_stream()
                  temp_path = download.path()
                  with open(temp_path, "rb") as f:
                      file_content = f.read()
                  
                  browser.close()
                  return file_name, file_content

          try:
              fname, fcontent = run_automation()
              print(f"üì• ƒê√£ l·∫•y file t·ª´ tr√¨nh duy·ªát: {fname}")

              token = get_access_token()
              headers = {"Authorization": f"Bearer {token}"}

              drive_res = requests.get(f"{GRAPH_API}/users/{USER_EMAIL}/drive", headers=headers).json()
              drive_id = drive_res["id"]

              upload_url = f"{GRAPH_API}/drives/{drive_id}/root:{OUT_FOLDER}/{fname}:/content?@microsoft.graph.conflictBehavior=replace"
              up_res = requests.put(upload_url, headers=headers, data=fcontent)

              if up_res.ok:
                  print(f"‚úÖ Upload th√†nh c√¥ng: {OUT_FOLDER}/{fname}")
              else:
                  print(f"‚ùå L·ªói upload OneDrive: {up_res.text}")

          except Exception as e:
              print(f"‚ùå L·ªói: {e}")
              exit(1)
          PYCODE
