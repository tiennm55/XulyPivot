name: IvyCPG DSR Historical Sync (Robust Version)

on:
  workflow_dispatch:
    inputs:
      days_back:
        description: 'S·ªë ng√†y mu·ªën l√πi v·ªÅ (v√≠ d·ª• -30)'
        required: true
        default: '-30'

jobs:
  sync_history:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright requests
          playwright install chromium

      - name: Run Historical Scraper (With Auto-Restart)
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          USER_EMAIL: "tiennm@tuanvietc5.id.vn"
          OUT_FOLDER: "/1.Job/2425/1. Tracking/Daily Sell Report/Data"
          DAYS_RANGE: ${{ github.event.inputs.days_back }}
        run: |
          python - <<'PYCODE'
          import os, time, requests, io
          from datetime import datetime, timedelta
          from playwright.sync_api import sync_playwright

          TENANT_ID = os.environ["TENANT_ID"]
          CLIENT_ID = os.environ["CLIENT_ID"]
          CLIENT_SECRET = os.environ["CLIENT_SECRET"]
          USER_EMAIL = os.environ["USER_EMAIL"]
          OUT_FOLDER = os.environ["OUT_FOLDER"]
          DAYS_RANGE = int(os.environ.get("DAYS_RANGE", -30))
          GRAPH_API = "https://graph.microsoft.com/v1.0"

          BRANCHES = [
              {"name": "CN BINH DINH", "code": "BDINH"}, {"name": "CN DA NANG", "code": "DNANG"},
              {"name": "CN HA TINH", "code": "HTINH"}, {"name": "CN HUE", "code": "HUE"},
              {"name": "CN KHANH HOA", "code": "KHOA"}, {"name": "CN PHU YEN", "code": "PHYEN"},
              {"name": "CN QUANG BINH", "code": "QBINH"}, {"name": "CN QUANG NAM", "code": "QNAM"},
              {"name": "CN QUANG NGAI", "code": "QNGAI"}, {"name": "CN QUANG TRI", "code": "QTRI"},
              {"name": "CN QUYNH LUU", "code": "QLUU"}, {"name": "CN THANH HOA", "code": "THOA"},
              {"name": "CN VINH", "code": "VINH"}
          ]

          def get_vn_now():
              return datetime.utcnow() + timedelta(hours=7)

          def get_access_token():
              url = f"https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token"
              data = {"grant_type": "client_credentials", "client_id": CLIENT_ID, "client_secret": CLIENT_SECRET, "scope": "https://graph.microsoft.com/.default"}
              return requests.post(url, data=data).json().get("access_token")

          def select_date_smart(iframe, target_dt):
              iframe.get_by_role("textbox", name="Date").click()
              time.sleep(1)
              current_now = get_vn_now()
              diff_month = (current_now.year - target_dt.year) * 12 + (current_now.month - target_dt.month)
              if diff_month > 0:
                  for _ in range(diff_month):
                      iframe.locator(".ui-icon-circle-triangle-w").click()
                      time.sleep(0.5)
              iframe.get_by_role("link", name=str(target_dt.day), exact=True).click()

          def download_report(page, branch, target_dt):
              print(f"   [{get_vn_now().strftime('%H:%M:%S')}] üåÄ {branch['code']} | {target_dt.strftime('%d/%m/%Y')}")
              page.get_by_role("link", name="Óöî DSR Today", exact=True).click()
              time.sleep(2)
              iframe_main = page.frame_locator("#iContent")
              iframe_main.get_by_role("textbox").first.click()
              iframe_main.get_by_role("list").get_by_text(branch['name'], exact=True).click()
              select_date_smart(iframe_main, target_dt)
              iframe_main.get_by_text("DSR Today").click()
              
              iframe_report = iframe_main.frame_locator("#myReportIFrame")
              export_btn = iframe_report.get_by_role("link", name="Export drop down menu Export")
              export_btn.wait_for(state="visible", timeout=120000)
              export_btn.click()

              with page.expect_download(timeout=60000) as download_info:
                  with page.expect_popup() as page1_info:
                      iframe_report.get_by_role("link", name="Excel").click()
                  page1 = page1_info.value
                  page1.close()
              
              download = download_info.value
              file_name = f"{branch['code']}_{target_dt.strftime('%d%m%y')}_Hist.xlsx"
              path = download.path()
              with open(path, "rb") as f:
                  data = f.read()
              # X√≥a file t·∫°m ngay ƒë·ªÉ gi·∫£i ph√≥ng Disk
              if os.path.exists(path): os.remove(path)
              return file_name, data

          # --- CH∆Ø∆†NG TR√åNH CH√çNH V·ªöI C∆† CH·∫æ RESTART ---
          try:
              token = get_access_token()
              headers = {"Authorization": f"Bearer {token}"}
              drive_res = requests.get(f"{GRAPH_API}/users/{USER_EMAIL}/drive", headers=headers).json()
              drive_id = drive_res["id"]

              # Ch·∫°y ng∆∞·ª£c t·ª´ ng√†y xa nh·∫•t
              for i in range(DAYS_RANGE, 1):
                  target_dt = get_vn_now() + timedelta(days=i)
                  print(f"\nüöÄ === B·∫ÆT ƒê·∫¶U NG√ÄY: {target_dt.strftime('%d/%m/%Y')} ===")

                  # KH·ªûI T·∫†O TR√åNH DUY·ªÜT M·ªöI CHO M·ªñI NG√ÄY ƒê·ªÇ GI·∫¢I PH√ìNG RAM
                  with sync_playwright() as p:
                      browser = p.chromium.launch(headless=True)
                      context = browser.new_context()
                      page = context.new_page()
                      
                      # ƒêƒÉng nh·∫≠p l·∫°i
                      page.goto("https://png-vn.ivycpg.com/web/")
                      page.get_by_role("textbox", name="Username *").fill("2001584413.admin")
                      page.get_by_role("textbox", name="Password *").fill("TVIET@2025#$")
                      page.get_by_role("button", name="Login").click()
                      page.wait_for_load_state("networkidle")
                      page.get_by_role("link", name="Óöî Reports ÓüÉ").click()

                      for branch in BRANCHES:
                          try:
                              fname, fcontent = download_report(page, branch, target_dt)
                              upload_url = f"{GRAPH_API}/drives/{drive_id}/root:{OUT_FOLDER}/{fname}:/content?@microsoft.graph.conflictBehavior=replace"
                              up_res = requests.put(upload_url, headers=headers, data=fcontent)
                              if up_res.ok: print(f"      ‚úÖ Upload xong: {fname}")
                              else: print(f"      ‚ùå L·ªói OneDrive {fname}: {up_res.text}")
                              time.sleep(1)
                          except Exception as e:
                              print(f"      ‚ö†Ô∏è L·ªói {branch['code']}: {e}")
                              continue
                      
                      # ƒê√≥ng tr√¨nh duy·ªát sau khi xong 1 ng√†y
                      browser.close()
                      print(f"üßπ ƒê√£ ƒë√≥ng tr√¨nh duy·ªát & d·ªçn d·∫πp RAM cho ng√†y ti·∫øp theo.")

          except Exception as e:
              print(f"‚ùå L·ªói h·ªá th·ªëng: {e}")
              exit(1)
          PYCODE
