name: Debug OneDrive Folder Structure

on:
  workflow_dispatch:  # Cho phÃ©p báº¡n cháº¡y thá»§ cÃ´ng tá»« tab Actions

jobs:
  debug-folders:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Run refresh script (debug OneDrive Documents)
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run: |
          python - <<'PYCODE'
          import os, requests

          TENANT_ID = os.environ["TENANT_ID"]
          CLIENT_ID = os.environ["CLIENT_ID"]
          CLIENT_SECRET = os.environ["CLIENT_SECRET"]
          USER_EMAIL = "tiennm@tuanvietc5.id.vn"  # Ä‘á»•i náº¿u email OneDrive khÃ¡c

          # ðŸ” Láº¥y access token
          token_url = f"https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token"
          token_data = {
              "grant_type": "client_credentials",
              "client_id": CLIENT_ID,
              "client_secret": CLIENT_SECRET,
              "scope": "https://graph.microsoft.com/.default"
          }
          token_resp = requests.post(token_url, data=token_data)
          token_json = token_resp.json()
          token = token_json.get("access_token")

          if not token:
              print("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c Access Token:")
              print(token_json)
              exit(1)

          headers = {"Authorization": f"Bearer {token}"}

          # ðŸ” Láº¥y danh sÃ¡ch táº¥t cáº£ drive cá»§a user (bao gá»“m Documents)
          drives_url = f"https://graph.microsoft.com/v1.0/users/{USER_EMAIL}/drives"
          drives_resp = requests.get(drives_url, headers=headers)
          drives_data = drives_resp.json()
          if "value" not in drives_data:
              print("âŒ KhÃ´ng tÃ¬m tháº¥y drives:", drives_data)
              exit(1)

          print("ðŸ“ Danh sÃ¡ch Drive cá»§a user:")
          for d in drives_data["value"]:
              print(f" - {d['name']} (id: {d['id']})")

          # ðŸ”§ Chá»n drive Ä‘áº§u tiÃªn (thÆ°á»ng lÃ  'Documents')
          DRIVE_ID = drives_data["value"][0]["id"]
          print(f"\nðŸ“‚ Sá»­ dá»¥ng Drive ID: {DRIVE_ID}\n")

          # ðŸ“„ In danh sÃ¡ch trong /Documents
          docs_url = f"https://graph.microsoft.com/v1.0/drives/{DRIVE_ID}/root:/Documents:/children"
          docs_resp = requests.get(docs_url, headers=headers)
          docs_json = docs_resp.json()

          print("ðŸ“„ Danh sÃ¡ch trong /Documents:")
          if "value" in docs_json:
              for item in docs_json["value"]:
                  print(" -", item["name"])
          else:
              print(docs_json)

          # ðŸ“ In ná»™i dung trong /Documents/1.Job
          print("\nðŸ“ Ná»™i dung trong /Documents/1.Job:")
          job_url = f"https://graph.microsoft.com/v1.0/drives/{DRIVE_ID}/root:/Documents/1.Job:/children"
          job_resp = requests.get(job_url, headers=headers)
          print(job_resp.json())
          PYCODE
