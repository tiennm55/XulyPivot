name: Refresh Excel Pivot on OneDrive

on:
  workflow_dispatch:  # Cháº¡y thá»§ cÃ´ng hoáº·c báº¡n cÃ³ thá»ƒ thÃªm schedule Ä‘á»ƒ tá»± Ä‘á»™ng háº±ng ngÃ y

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests openpyxl

      - name: Run refresh script (all Excel files)
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          FOLDER_PATH: "/1.Job/2425/1. Tracking/Pivot_Month_Par"
          USER_EMAIL: "tiennm@tuanvietc5.id.vn"
        run: |
          python - <<'PYCODE'
          import io, os, requests
          from openpyxl import load_workbook

          TENANT_ID = os.environ["TENANT_ID"]
          CLIENT_ID = os.environ["CLIENT_ID"]
          CLIENT_SECRET = os.environ["CLIENT_SECRET"]
          USER_EMAIL = os.environ["USER_EMAIL"]
          FOLDER_PATH = os.environ["FOLDER_PATH"]

          # ðŸ” Láº¥y access token
          token_url = f"https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token"
          token_data = {
              "grant_type": "client_credentials",
              "client_id": CLIENT_ID,
              "client_secret": CLIENT_SECRET,
              "scope": "https://graph.microsoft.com/.default"
          }
          token = requests.post(token_url, data=token_data).json().get("access_token")
          if not token:
              print("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c Access Token.")
              exit(1)
          headers = {"Authorization": f"Bearer {token}"}

          # ðŸ“ XÃ¡c Ä‘á»‹nh á»• OneDrive Business cá»§a user
          drives = requests.get(f"https://graph.microsoft.com/v1.0/users/{USER_EMAIL}/drives", headers=headers).json()
          drive_id = [d["id"] for d in drives["value"] if "OneDrive" in d["name"]][0]
          print(f"ðŸ“‚ Drive ID: {drive_id}")

          # ðŸ—‚ï¸ Liá»‡t kÃª toÃ n bá»™ file trong thÆ° má»¥c cáº§n xá»­ lÃ½
          list_url = f"https://graph.microsoft.com/v1.0/drives/{drive_id}/root:{FOLDER_PATH}:/children"
          resp = requests.get(list_url, headers=headers)
          files = resp.json().get("value", [])
          if not files:
              print(f"âš ï¸ KhÃ´ng tÃ¬m tháº¥y file nÃ o trong thÆ° má»¥c: {FOLDER_PATH}")
              print("Response:", resp.text)
              exit()

          # ðŸ§® Duyá»‡t tá»«ng file Excel
          for f in files:
              name = f["name"]
              if not name.lower().endswith(".xlsx"):
                  continue
              file_url = f"https://graph.microsoft.com/v1.0/drives/{drive_id}/root:{FOLDER_PATH}/{name}:/content"

              print(f"\nðŸ“¥ Äang xá»­ lÃ½ file: {name}")
              try:
                  # ðŸ“¥ Táº£i file Excel
                  data = requests.get(file_url, headers=headers).content
                  wb = load_workbook(io.BytesIO(data), data_only=False)

                  # ðŸ” Refresh Pivot Cache
                  refreshed = False
                  for sheet in wb.worksheets:
                      if hasattr(sheet, "_pivots"):
                          for p in sheet._pivots:
                              p.cache.refreshOnLoad = True
                              refreshed = True

                  if refreshed:
                      print(f"âœ… ÄÃ£ báº­t refreshOnLoad cho Pivot trong {name}")
                  else:
                      print(f"â„¹ï¸ KhÃ´ng tÃ¬m tháº¥y PivotTable trong {name}")

                  # ðŸ’¾ Ghi Ä‘Ã¨ ngÆ°á»£c lÃªn OneDrive
                  buffer = io.BytesIO()
                  wb.save(buffer)
                  buffer.seek(0)
                  put_resp = requests.put(file_url, headers=headers, data=buffer)
                  if put_resp.status_code < 300:
                      print(f"ðŸ“¤ ÄÃ£ cáº­p nháº­t {name} lÃªn OneDrive thÃ nh cÃ´ng.")
                  else:
                      print(f"âš ï¸ Upload lá»—i {name}: {put_resp.text}")

              except Exception as e:
                  print(f"âŒ Lá»—i khi xá»­ lÃ½ {name}: {e}")

          print("\nðŸ HoÃ n táº¥t xá»­ lÃ½ táº¥t cáº£ cÃ¡c file Excel.")
          PYCODE
