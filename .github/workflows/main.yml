name: Extract PivotCache from Pivot_Month_Par via Excel Gateway (Fixed Route)

on:
  workflow_dispatch:

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install pandas pyarrow openpyxl lxml requests

      - name: Run Pivot Extract via Gateway (Fixed)
        env:
          BASE_URL: "https://msgraph-excel-gateway.tuanvietc5.workers.dev"
          APIKEY: "EG2025_1"
          UPN: "tiennm@tuanvietc5.id.vn"
          FOLDER: "/1.Job/2425/1. Tracking/Pivot_Month_Par"
        run: |
          python - <<'PYCODE'
          import io, os, zipfile, requests, pandas as pd
          from lxml import etree

          BASE_URL = os.environ["BASE_URL"]
          APIKEY = os.environ["APIKEY"]
          UPN = os.environ["UPN"]
          FOLDER = os.environ["FOLDER"]

          params = {"path": FOLDER, "upn": UPN, "key": APIKEY}

          # ====== ðŸ“‚ Láº¤Y DANH SÃCH FILE ======
          list_url = f"{BASE_URL}/od/list"
          res = requests.get(list_url, params=params)
          if not res.ok:
              print("âŒ Lá»—i khi láº¥y danh sÃ¡ch:", res.text)
              exit(1)

          data = res.json()
          files = [f for f in data.get("items", []) if f["name"].lower().endswith(".xlsx")]

          if not files:
              print("âš ï¸ KhÃ´ng tÃ¬m tháº¥y file .xlsx nÃ o trong thÆ° má»¥c:", FOLDER)
              print("Response:", res.text)
              exit()

          print(f"ðŸ”Ž TÃ¬m tháº¥y {len(files)} file trong {FOLDER}")

          # ====== ðŸ” Xá»¬ LÃ Tá»ªNG FILE ======
          for f in files:
              name = f["name"]
              print(f"\nðŸ“¥ Äang xá»­ lÃ½: {name}")

              # âœ… Äá»”I Láº I endpoint tá»« /od/download âžœ /od/file
              dl_params = {"path": FOLDER, "name": name, "upn": UPN, "key": APIKEY}
              dl_url = f"{BASE_URL}/od/file"

              resp = requests.get(dl_url, params=dl_params)
              excel_bytes = resp.content

              # ðŸ§  DEBUG KIá»‚M TRA Äá»ŠNH Dáº NG FILE
              if excel_bytes[:4] != b'PK\x03\x04':
                  print(f"âš ï¸ File {name} KHÃ”NG PHáº¢I ZIP (Excel). 20 byte Ä‘áº§u tiÃªn lÃ :", excel_bytes[:20])
                  print("ðŸ” HTTP status:", resp.status_code)
                  try:
                      print("ðŸ” Response text:")
                      print(resp.text[:500])
                  except Exception as e:
                      print("âŒ KhÃ´ng thá»ƒ Ä‘á»c text response:", e)
                  continue

              try:
                  with zipfile.ZipFile(io.BytesIO(excel_bytes)) as z:
                      record_files = [p for p in z.namelist() if "pivotCacheRecords" in p]
                      if not record_files:
                          print("âš ï¸ KhÃ´ng cÃ³ PivotCacheRecords trong file.")
                          continue

                      for record_file in record_files:
                          print(f"ðŸ” Bung {record_file} ...")
                          xml_data = z.read(record_file)
                          root = etree.fromstring(xml_data)
                          ns = {"d": "http://schemas.openxmlformats.org/spreadsheetml/2006/main"}

                          rows = []
                          for r in root.findall(".//d:r", ns):
                              values = [x.text for x in r.findall(".//d:x", ns)]
                              if values:
                                  rows.append(values)

                          if not rows:
                              print("âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u trong cache.")
                              continue

                          df = pd.DataFrame(rows)
                          print(f"âœ… Bung Ä‘Æ°á»£c {len(df)} dÃ²ng tá»« {name}.")

                          # ====== ðŸ’¾ GHI RA FILE .PARQUET ======
                          base_name = name.replace(".xlsx", "")
                          out_parquet = f"{base_name}_cache.parquet"

                          buf_parq = io.BytesIO()
                          df.to_parquet(buf_parq, index=False)
                          buf_parq.seek(0)

                          ul_params = {
                              "path": FOLDER,
                              "file": out_parquet,
                              "upn": UPN,
                              "key": APIKEY
                          }

                          upload_url = f"{BASE_URL}/od/upload"
                          up = requests.put(upload_url, params=ul_params, data=buf_parq)

                          if up.ok:
                              print(f"ðŸ“¤ ÄÃ£ ghi {out_parquet} thÃ nh cÃ´ng!")
                          else:
                              print(f"âŒ Upload lá»—i ({out_parquet}):", up.text)

              except Exception as e:
                  print(f"âŒ Lá»—i khi xá»­ lÃ½ {name}: {e}")

          print("\nðŸ HoÃ n táº¥t bung toÃ n bá»™ Pivot Cache.")
          PYCODE
