name: Debug OneDrive Root Folder

on:
  workflow_dispatch:

jobs:
  debug-folders:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Run OneDrive root folder scan
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run: |
          python - <<'PYCODE'
          import os, requests

          TENANT_ID = os.environ["TENANT_ID"]
          CLIENT_ID = os.environ["CLIENT_ID"]
          CLIENT_SECRET = os.environ["CLIENT_SECRET"]
          USER_EMAIL = "tiennm@tuanvietc5.id.vn"

          # ðŸ” Láº¥y access token
          token_url = f"https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token"
          token_data = {
              "grant_type": "client_credentials",
              "client_id": CLIENT_ID,
              "client_secret": CLIENT_SECRET,
              "scope": "https://graph.microsoft.com/.default"
          }
          token = requests.post(token_url, data=token_data).json().get("access_token")
          if not token:
              print("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c access token.")
              exit(1)

          headers = {"Authorization": f"Bearer {token}"}

          # ðŸ§­ Láº¥y danh sÃ¡ch á»• OneDrive
          drives = requests.get(f"https://graph.microsoft.com/v1.0/users/{USER_EMAIL}/drives", headers=headers).json()
          for d in drives["value"]:
              print("ðŸ“‚", d["name"], "â†’", d["id"])

          # ðŸ‘‰ Chá»n á»• OneDrive chÃ­nh
          drive_id = [d["id"] for d in drives["value"] if "OneDrive" in d["name"]][0]
          print(f"\nâœ… DÃ¹ng Drive ID: {drive_id}\n")

          # ðŸ—‚ï¸ In danh sÃ¡ch thÆ° má»¥c ngay trong root
          print("ðŸ“„ Danh sÃ¡ch thÆ° má»¥c trong root:")
          root_resp = requests.get(f"https://graph.microsoft.com/v1.0/drives/{drive_id}/root/children", headers=headers)
          root_data = root_resp.json()
          if "value" not in root_data:
              print(root_data)
              exit()
          for item in root_data["value"]:
              print(" -", item["name"])

          # ðŸ§© Thá»­ truy cáº­p thÆ° má»¥c 1.Job
          print("\nðŸ“ Ná»™i dung thÆ° má»¥c /1.Job:")
          job_url = f"https://graph.microsoft.com/v1.0/drives/{drive_id}/root:/1.Job:/children"
          job_data = requests.get(job_url, headers=headers).json()
          print(job_data)
          PYCODE
